<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Underemployment Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            font-size: 14px;
        }

        .container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin: 10px;
            gap: 10px;
        }

        .container .left,
        .container .right {
            flex: 1;
            max-width: 50%;
        }

        #svg-container {
            flex: 1;
            min-width: 300px;
            max-width: 100%;
            height: 600px;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            cursor: grab;
            user-select: none;
        }

        #svg-container svg {
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        #tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 3px;
            display: none;
            pointer-events: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            overflow-x: auto;
            max-height: 600px;
            display: block;
            overflow-y: scroll;
        }

        th, td {
            padding: 8px 12px;
            text-align: left;
        }

        th {
            border-bottom: 2px solid rgb(30, 155, 138);
            font-weight: normal;
            position: sticky;
            top: 0;
            cursor: default;
            background-color: white;
        }

        .sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
        }

        table tr:nth-child(odd) {
            background-color: white;
        }

        table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        table select {
            margin: 10px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div>
        <label for="ind-slicer">Industry:</label>
        <select id="ind-slicer">
            <option value="Utilities" selected>Utilities</option>
        </select>

        <label for="nativity-slicer">Nativity:</label>
        <select id="nativity-slicer">
            <option value="Domestic" selected>Domestic</option>
        </select>
    </div>

    <div class="container">
        <div class="left">
            <div id="svg-container">
                <svg id="map"></svg>
            </div>
            <!-- Continuous Color Key placed outside of SVG container -->
            <div id="color-key" style="
                position: absolute;
                bottom: 20px;
                left: 20px;
                width: 300px;
                height: 20px;
                background: linear-gradient(to right, 
                    #fde725, #c2df23, #86d549, #52c569, #2ab07f, 
                    #1e9b8a, #25858e, #2d708e, #38588c, #433e85, 
                    #482173, #440154);
                border: 1px solid #ddd;
                border-radius: 5px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                font-size: 12px;
                padding: 5px;
                z-index: 10; /* Ensure it stays on top */
            ">
                <span style="position: absolute; left: 0; bottom: -20px;">0</span>
                <span style="position: absolute; left: 50%; bottom: -20px;">1</span>
                <span style="position: absolute; right: 0; bottom: -20px;">2</span>
            </div>
            <div id="tooltip"></div>
        </div>
    
        <div class="right">
            <table id="data-table">
                <thead>
                    <tr>
                        <th><span>Region</span><span class="sort-icon"></span></th>
                        <th><span>IND</span><span class="sort-icon"></span></th>
                        <th><span>NATIVITY</span><span class="sort-icon"></span></th>
                        <th><span>Mean Wage</span><span class="sort-icon"></span></th>
                        <th><span>Mean Other Income</span><span class="sort-icon"></span></th>
                        <th><span>Mean Age</span><span class="sort-icon"></span></th>
                        <th><span>Underemployment Level</span><span class="sort-icon"></span></th>
                        <th><span>Education Level</span><span class="sort-icon"></span></th>
                        <th><span>Required Education Level</span><span class="sort-icon"></span></th>
                        <th><span>Nativity Percentage</span><span class="sort-icon"></span></th>
                        <th><span>ID</span><span class="sort-icon"></span></th>
                        <th><span>Counties</span><span class="sort-icon"></span></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let offsetX = 0;
            let offsetY = 0;
            let scale = 1;
            let selectedRegion = null;
            const tooltip = document.getElementById('tooltip');
            const svgContainer = document.getElementById('svg-container');
            const tableBody = document.querySelector('#data-table tbody');
            const paths = new Map(); // To store paths by ID for efficient lookup
            let data = []; // To store loaded JSON data

            // Load SVG and initialize map
            fetch('paths.svg')
                .then(response => response.text())
                .then(svgContent => {
                    svgContainer.querySelector('svg').innerHTML = svgContent;
                    initializePaths();
                })
                .catch(error => console.error('Error loading SVG:', error));

            // Load JSON data and populate table and slicers
            fetch('aggregated_data.json')
                .then(response => response.json())
                .then(jsonData => {
                    data = jsonData;
                    populateTable(data);
                    populateSlicers(data);
                    updateMapColors();
                })
                .catch(error => console.error('Error loading JSON:', error));

            // Initialize SVG paths
            function initializePaths() {
                svgContainer.querySelectorAll('path').forEach(path => {
                    const id = path.id;
                    if (id) {
                        paths.set(id, path);
                        path.addEventListener('mouseenter', showTooltip);
                        path.addEventListener('mouseleave', hideTooltip);
                        path.addEventListener('mousemove', moveTooltip);
                        path.addEventListener('click', () => toggleRegionSelection(id));
                    }
                });
            }

            // Tooltip handling
            function showTooltip(event) {
                const regionId = event.target.id;
                tooltip.textContent = `Region: ${regionId}`;
                tooltip.style.display = 'block';
                moveTooltip(event);
            }

            function hideTooltip() {
                tooltip.style.display = 'none';
            }

            function moveTooltip(event) {
                tooltip.style.left = `${event.pageX + 10}px`;
                tooltip.style.top = `${event.pageY + 10}px`;
            }

            // Region selection
            function toggleRegionSelection(regionId) {
                selectedRegion = selectedRegion === regionId ? null : regionId;
                updateRegionHighlight();
                filterTable();
            }

            function updateRegionHighlight() {
                paths.forEach((path, id) => {
                    path.style.opacity = id === selectedRegion ? '1' : '0.3';
                });
            }

            // Populate table
            function populateTable(data) {
                tableBody.innerHTML = '';
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.dataset.region = item.ID;
                    row.innerHTML = `
                        <td>${item.STATE || ''}</td>
                        <td>${item.IND || ''}</td>
                        <td>${item.NATIVITY || ''}</td>
                        <td>${formatCurrency(item.MEAN_WAGE)}</td>
                        <td>${formatCurrency(item.MEAN_OTHER_INCOME)}</td>
                        <td>${formatNumber(item.MEAN_AGE, 1)}</td>
                        <td>${formatNumber(item.UNDEREMPLOYMENT_LEVEL, 2)}</td>
                        <td>${formatNumber(item.EDUCATION_LEVEL, 2)}</td>
                        <td>${formatNumber(item.REQUIRED_EDUCATION_LEVEL, 2)}</td>
                        <td>${formatPercentage(item.NATIVITY_PERCENTAGE)}</td>
                        <td>${item.ID || ''}</td>
                        <td>${item.COUNTIES || ''}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            // Populate slicers
            function populateSlicers(data) {
                const indSlicer = document.getElementById('ind-slicer');
                const nativitySlicer = document.getElementById('nativity-slicer');
                populateSlicer(indSlicer, [...new Set(data.map(item => item.IND))]);
                populateSlicer(nativitySlicer, [...new Set(data.map(item => item.NATIVITY))]);

                indSlicer.addEventListener('change', filterTable);
                nativitySlicer.addEventListener('change', filterTable);
            }

            function populateSlicer(slicer, options) {
                slicer.innerHTML = '<option value="">All</option>';
                options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    slicer.appendChild(opt);
                });
            }

            // Filter table and update map
            function filterTable() {
                const indValue = document.getElementById('ind-slicer').value;
                const nativityValue = document.getElementById('nativity-slicer').value;

                const filteredData = data.filter(item => {
                    const matchesInd = !indValue || item.IND === indValue;
                    const matchesNativity = !nativityValue || item.NATIVITY === nativityValue;
                    const matchesRegion = !selectedRegion || item.ID === selectedRegion;
                    return matchesInd && matchesNativity && matchesRegion;
                });

                populateTable(filteredData);
                updateMapColors(filteredData);
            }

            // Update map colors
            function updateMapColors(filteredData = data) {
                const underemploymentMap = new Map(
                    filteredData.map(item => [item.ID, item.UNDEREMPLOYMENT_LEVEL])
                );

                paths.forEach((path, id) => {
                    const level = underemploymentMap.get(id);
                    path.style.fill = getColorForUnderemployment(level);
                });
            }

            // Color scale logic
            function getColorForUnderemployment(level) {
                if (level == null || isNaN(level)) return '#e9e9e9';
                const clampedLevel = Math.min(Math.max(level, 0), 2);
                const ratio = clampedLevel / 2;
                const colors = ['#440154', '#3b528b', '#21918c', '#5ec962', '#fde725'];
                const index = Math.floor(ratio * (colors.length - 1));
                return colors[index];
            }

            // Formatting helpers
            function formatCurrency(value) {
                return value != null && !isNaN(value)
                    ? `$${Number(value).toLocaleString()}`
                    : '';
            }

            function formatNumber(value, decimals = 0) {
                return value != null && !isNaN(value)
                    ? Number(value).toFixed(decimals)
                    : '';
            }

            function formatPercentage(value) {
                return value != null && !isNaN(value)
                    ? `${(value * 100).toFixed(1)}%`
                    : '';
            }
        });


    </script>
    
</body>
</html>